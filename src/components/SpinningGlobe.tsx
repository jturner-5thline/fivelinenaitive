import { useRef, useMemo } from 'react';
import { Canvas, useFrame } from '@react-three/fiber';
import { Sphere, OrbitControls } from '@react-three/drei';
import * as THREE from 'three';

// Earth's axial tilt is 23.5 degrees
const AXIAL_TILT = 23.5 * (Math.PI / 180);

// Calculate the seasonal tilt direction based on current date
// Summer solstice (June 21) = day 172, North Pole tilts toward sun
// Winter solstice (Dec 21) = day 355, North Pole tilts away from sun
function getSeasonalTilt(): { x: number; z: number } {
  const now = new Date();
  const startOfYear = new Date(now.getFullYear(), 0, 0);
  const diff = now.getTime() - startOfYear.getTime();
  const dayOfYear = Math.floor(diff / (1000 * 60 * 60 * 24));
  
  // Summer solstice is around day 172 (June 21)
  // We want the tilt to rotate through the year
  // At summer solstice, North Pole tilts toward viewer (positive X tilt)
  // At winter solstice, North Pole tilts away (negative X tilt)
  const summerSolsticeDay = 172;
  const daysFromSolstice = dayOfYear - summerSolsticeDay;
  const yearProgress = (daysFromSolstice / 365) * Math.PI * 2;
  
  // The tilt rotates around the Y axis through the year
  return {
    x: Math.cos(yearProgress) * AXIAL_TILT,
    z: Math.sin(yearProgress) * AXIAL_TILT,
  };
}

// More accurate continent outline coordinates [lat, lon] pairs
const continentOutlines = {
  northAmerica: [
    [49, -125], [50, -127], [54, -130], [57, -135], [59, -139], [60, -141],
    [60, -147], [59, -152], [58, -153], [56, -154], [55, -160], [57, -163],
    [59, -163], [62, -166], [64, -166], [66, -164], [68, -166], [70, -163],
    [71, -157], [71, -152], [70, -148], [69, -141], [70, -139], [70, -130],
    [69, -125], [71, -118], [73, -114], [75, -95], [75, -85], [72, -78],
    [70, -70], [67, -63], [63, -58], [60, -64], [55, -56], [50, -56],
    [47, -53], [45, -61], [43, -66], [41, -70], [40, -74], [39, -75],
    [37, -76], [35, -75], [32, -79], [30, -81], [28, -82], [26, -80],
    [25, -80], [24, -82], [22, -84], [19, -87], [18, -88], [16, -88],
    [15, -92], [16, -95], [19, -96], [21, -97], [22, -98], [24, -98],
    [26, -99], [27, -97], [26, -97], [25, -99], [28, -105], [29, -108],
    [31, -111], [31, -114], [32, -117], [34, -119], [36, -122], [38, -123],
    [40, -124], [43, -124], [46, -124], [49, -125]
  ],
  southAmerica: [
    [12, -72], [11, -74], [9, -77], [7, -77], [4, -77], [1, -79],
    [-1, -80], [-4, -81], [-6, -81], [-5, -79], [-4, -78], [-6, -77],
    [-14, -76], [-18, -70], [-23, -70], [-27, -71], [-33, -72], [-38, -73],
    [-42, -73], [-46, -75], [-50, -74], [-52, -71], [-54, -68], [-55, -66],
    [-55, -64], [-53, -68], [-51, -69], [-48, -66], [-46, -67], [-42, -65],
    [-39, -62], [-36, -57], [-34, -54], [-32, -52], [-28, -49], [-25, -47],
    [-22, -41], [-18, -39], [-13, -38], [-10, -35], [-7, -35], [-5, -37],
    [-2, -42], [0, -50], [2, -54], [5, -55], [6, -58], [8, -60],
    [10, -62], [11, -68], [12, -72]
  ],
  europe: [
    [71, 28], [70, 32], [68, 42], [67, 44], [66, 34], [64, 30],
    [62, 31], [60, 28], [59, 31], [56, 32], [54, 28], [55, 22],
    [54, 14], [54, 10], [56, 8], [58, 10], [57, 7], [55, 8],
    [54, 8], [53, 5], [52, 4], [51, 4], [51, 2], [50, 0],
    [49, -1], [48, -5], [47, -2], [44, -1], [43, -2], [42, -9],
    [37, -9], [36, -6], [36, -2], [38, 0], [40, 0], [41, 1],
    [42, 3], [43, 5], [44, 8], [44, 12], [41, 14], [38, 16],
    [36, 22], [38, 24], [40, 26], [41, 29], [44, 28], [45, 30],
    [46, 17], [47, 15], [48, 17], [49, 18], [50, 20], [52, 21],
    [54, 19], [55, 21], [56, 21], [58, 24], [60, 21], [63, 20],
    [66, 24], [68, 26], [71, 28]
  ],
  africa: [
    [37, -6], [36, 0], [37, 10], [33, 12], [32, 25], [31, 32],
    [27, 34], [22, 37], [15, 43], [12, 45], [11, 51], [2, 51],
    [-1, 43], [-5, 41], [-11, 40], [-16, 38], [-19, 35], [-25, 33],
    [-29, 32], [-33, 28], [-35, 20], [-34, 18], [-31, 17], [-29, 16],
    [-26, 15], [-22, 14], [-17, 12], [-13, 14], [-8, 14], [-5, 12],
    [-5, 8], [-4, 5], [2, 1], [5, -4], [5, -8], [10, -15],
    [15, -17], [19, -17], [21, -17], [26, -15], [28, -13], [32, -9],
    [35, -6], [37, -6]
  ],
  asia: [
    [42, 29], [41, 35], [37, 36], [33, 35], [29, 35], [27, 34],
    [22, 60], [24, 68], [20, 73], [8, 77], [6, 80], [8, 93],
    [16, 96], [21, 93], [23, 89], [22, 88], [21, 91], [18, 97],
    [10, 99], [1, 103], [-3, 104], [-7, 106], [-8, 114], [-8, 117],
    [-6, 120], [-3, 129], [1, 128], [5, 120], [7, 117], [10, 119],
    [18, 110], [22, 107], [22, 114], [30, 122], [35, 129], [38, 124],
    [42, 130], [45, 136], [46, 143], [50, 143], [53, 143], [51, 155],
    [57, 153], [59, 163], [62, 165], [65, 169], [66, 179], [69, -180],
    [71, -180], [68, 165], [70, 160], [73, 140], [77, 105], [76, 97],
    [73, 85], [73, 70], [70, 60], [68, 55], [66, 60], [62, 65],
    [55, 73], [54, 70], [50, 80], [46, 82], [44, 80], [42, 75],
    [43, 52], [40, 50], [38, 48], [40, 44], [42, 42], [42, 35],
    [42, 29]
  ],
  australia: [
    [-12, 130], [-14, 127], [-15, 124], [-17, 123], [-19, 121],
    [-21, 114], [-26, 113], [-29, 114], [-32, 115], [-34, 116],
    [-35, 117], [-35, 119], [-34, 124], [-32, 127], [-32, 133],
    [-34, 135], [-35, 137], [-36, 140], [-39, 146], [-38, 148],
    [-36, 150], [-34, 151], [-32, 153], [-28, 154], [-25, 153],
    [-20, 149], [-18, 146], [-16, 145], [-14, 144], [-12, 142],
    [-11, 136], [-12, 130]
  ],
  antarctica: [
    [-65, -60], [-70, -60], [-75, -70], [-78, -80], [-80, -100],
    [-78, -120], [-75, -140], [-70, -150], [-68, -160], [-70, -170],
    [-75, 180], [-78, 160], [-80, 140], [-78, 100], [-75, 80],
    [-70, 60], [-68, 40], [-70, 20], [-75, 0], [-70, -20],
    [-68, -40], [-65, -60]
  ]
};

// Major city coordinates [lat, lon] for city lights - comprehensive list
const cityLights: [number, number][] = [
  // North America - USA - Major metros
  [40.71, -74.01], [40.76, -73.98], [40.68, -73.95], [40.85, -73.87], [40.65, -73.75],
  [34.05, -118.24], [34.02, -118.49], [33.94, -118.24], [34.18, -118.53], [33.85, -118.39],
  [41.88, -87.63], [41.79, -87.60], [42.01, -87.67], [41.85, -87.75], [41.92, -87.70],
  [29.76, -95.37], [29.68, -95.28], [29.84, -95.45], [29.72, -95.55], [29.95, -95.35],
  [33.45, -112.07], [33.52, -112.15], [33.38, -111.92], [33.61, -112.18], [33.32, -111.84],
  [29.42, -98.49], [29.53, -98.57], [29.35, -98.40], [29.48, -98.52], [29.60, -98.45],
  [32.78, -96.80], [32.85, -96.75], [32.92, -96.62], [32.72, -96.88], [33.02, -96.70],
  [37.77, -122.42], [37.73, -122.38], [37.82, -122.27], [37.56, -122.27], [37.87, -122.26],
  [47.61, -122.33], [47.55, -122.38], [47.67, -122.12], [47.45, -122.30], [47.72, -122.34],
  [39.74, -104.99], [39.68, -104.82], [39.85, -105.08], [39.53, -104.92], [39.92, -105.05],
  [38.91, -77.04], [38.85, -77.12], [38.98, -76.94], [38.78, -77.18], [39.02, -77.02],
  [42.36, -71.06], [42.32, -71.08], [42.41, -70.99], [42.28, -71.15], [42.38, -71.22],
  [33.75, -84.39], [33.82, -84.32], [33.68, -84.45], [33.92, -84.38], [33.58, -84.42],
  [25.76, -80.19], [25.68, -80.32], [25.85, -80.12], [26.12, -80.14], [25.92, -80.25],
  [36.17, -115.14], [36.08, -115.22], [36.25, -115.05], [36.02, -115.08], [36.32, -115.18],
  [35.23, -80.84], [35.18, -80.92], [35.32, -80.76], [35.12, -80.88], [35.28, -80.70],
  [32.72, -117.16], [32.78, -117.08], [32.65, -117.22], [32.85, -117.12], [32.58, -117.05],
  [45.52, -122.68], [45.48, -122.78], [45.58, -122.58], [45.42, -122.72], [45.62, -122.65],
  [30.27, -97.74], [30.35, -97.68], [30.18, -97.82], [30.42, -97.62], [30.22, -97.88],
  [39.10, -94.58], [39.05, -94.65], [39.18, -94.52], [38.98, -94.72], [39.22, -94.48],
  [36.16, -86.78], [36.22, -86.85], [36.08, -86.70], [36.28, -86.68], [36.02, -86.82],
  [39.96, -82.99], [39.88, -83.08], [40.05, -82.88], [39.78, -83.05], [40.12, -82.95],
  [35.47, -97.52], [35.55, -97.45], [35.38, -97.62], [35.62, -97.48], [35.42, -97.58],
  [44.98, -93.27], [45.05, -93.18], [44.88, -93.35], [45.12, -93.22], [44.82, -93.42],
  [38.25, -85.76], [38.32, -85.68], [38.18, -85.85], [38.38, -85.72], [38.12, -85.78],
  [43.04, -87.91], [43.12, -87.82], [42.95, -88.02], [43.18, -87.88], [42.88, -87.95],
  [35.15, -90.05], [35.22, -89.95], [35.08, -90.12], [35.28, -90.02], [35.02, -89.88],
  [42.33, -83.05], [42.42, -82.95], [42.25, -83.15], [42.48, -83.02], [42.18, -83.22],
  [27.95, -82.46], [28.02, -82.38], [27.88, -82.55], [27.78, -82.62], [28.12, -82.42],
  [33.52, -86.80], [33.58, -86.72], [33.45, -86.88], [33.62, -86.75], [33.38, -86.92],
  [36.85, -76.29], [36.92, -76.22], [36.78, -76.38], [36.98, -76.15], [36.72, -76.32],
  [37.54, -77.44], [37.62, -77.35], [37.45, -77.52], [37.68, -77.42], [37.38, -77.58],
  [41.50, -81.69], [41.58, -81.58], [41.42, -81.78], [41.65, -81.62], [41.35, -81.85],
  [32.08, -81.09], [32.15, -81.02], [32.02, -81.18], [32.22, -80.98], [31.95, -81.15],
  [28.54, -81.38], [28.62, -81.28], [28.45, -81.48], [28.72, -81.32], [28.38, -81.55],
  [36.07, -79.79], [36.15, -79.72], [36.02, -79.88], [36.22, -79.68], [35.95, -79.82],
  [39.29, -76.61], [39.35, -76.52], [39.22, -76.72], [39.42, -76.58], [39.15, -76.78],
  [40.44, -79.99], [40.52, -79.88], [40.35, -80.08], [40.58, -79.95], [40.28, -80.12],
  [21.31, -157.86], [21.28, -157.78], [21.35, -157.92], [21.42, -157.82], [21.22, -157.75],
  // More USA cities
  [42.88, -78.88], [43.15, -77.62], [42.45, -76.50], [40.01, -75.13], [39.95, -75.16],
  [40.75, -73.55], [41.08, -74.03], [40.92, -74.17], [40.22, -74.77], [40.35, -74.65],
  [38.58, -121.49], [37.34, -121.89], [36.75, -119.79], [38.44, -122.71], [37.55, -122.05],
  [33.68, -117.83], [33.82, -117.92], [33.42, -117.62], [33.62, -117.93], [33.75, -117.87],
  [32.92, -96.95], [33.08, -97.05], [32.62, -97.08], [32.75, -97.33], [33.22, -97.12],
  [26.22, -98.23], [26.52, -98.08], [25.90, -97.50], [27.52, -99.50], [26.38, -98.82],
  [35.08, -106.65], [35.22, -106.72], [35.68, -105.94], [32.35, -106.76], [34.52, -105.98],
  [36.73, -108.22], [35.12, -107.85], [34.45, -103.20], [36.08, -106.32], [35.60, -106.08],
  // North America - Canada
  [43.65, -79.38], [43.72, -79.28], [43.58, -79.48], [43.78, -79.42], [43.52, -79.62],
  [45.50, -73.57], [45.55, -73.48], [45.42, -73.68], [45.62, -73.52], [45.38, -73.78],
  [49.28, -123.12], [49.22, -123.05], [49.35, -123.22], [49.15, -123.08], [49.42, -123.18],
  [51.05, -114.07], [51.12, -113.98], [50.95, -114.18], [51.18, -114.02], [50.88, -114.22],
  [53.55, -113.49], [53.62, -113.38], [53.45, -113.58], [53.72, -113.42], [53.38, -113.65],
  [45.42, -75.70], [45.48, -75.62], [45.35, -75.78], [45.52, -75.55], [45.28, -75.85],
  [49.90, -97.14], [49.85, -97.08], [49.95, -97.22], [49.78, -97.18], [50.02, -97.12],
  [44.65, -63.58], [44.72, -63.52], [44.58, -63.68], [44.78, -63.45], [44.52, -63.75],
  [43.26, -79.87], [43.32, -79.78], [43.18, -79.95], [43.38, -79.82], [43.12, -80.02],
  [42.98, -81.25], [43.05, -81.18], [42.92, -81.32], [43.12, -81.22], [42.85, -81.38],
  // North America - Mexico
  [19.43, -99.13], [19.38, -99.18], [19.48, -99.08], [19.32, -99.22], [19.55, -99.05],
  [19.52, -99.02], [19.28, -99.28], [19.62, -99.12], [19.22, -99.08], [19.58, -98.95],
  [20.67, -103.35], [20.72, -103.28], [20.62, -103.42], [20.78, -103.32], [20.55, -103.48],
  [25.67, -100.32], [25.72, -100.25], [25.62, -100.38], [25.78, -100.28], [25.55, -100.42],
  [32.52, -117.02], [32.58, -116.95], [32.45, -117.08], [32.65, -116.98], [32.38, -117.15],
  [31.87, -116.60], [31.92, -116.52], [31.82, -116.68], [31.98, -116.55], [31.75, -116.72],
  [22.15, -100.98], [22.22, -100.92], [22.08, -101.05], [22.28, -100.88], [22.02, -101.12],
  [20.97, -89.62], [21.02, -89.55], [20.92, -89.68], [21.08, -89.58], [20.85, -89.75],
  [21.16, -86.85], [21.22, -86.78], [21.08, -86.92], [21.28, -86.72], [21.02, -86.98],
  [17.07, -96.72], [17.12, -96.65], [17.02, -96.78], [17.18, -96.68], [16.95, -96.82],
  [19.18, -96.14], [19.25, -96.08], [19.12, -96.22], [19.32, -96.02], [19.05, -96.28],
  // Central America & Caribbean
  [23.14, -82.36], [23.08, -82.42], [23.22, -82.28], [23.02, -82.48], [23.28, -82.22],
  [18.47, -69.90], [18.52, -69.82], [18.42, -69.98], [18.58, -69.85], [18.35, -70.05],
  [14.63, -90.51], [14.68, -90.45], [14.58, -90.58], [14.72, -90.42], [14.52, -90.65],
  [13.69, -89.19], [13.75, -89.12], [13.62, -89.25], [13.82, -89.08], [13.55, -89.32],
  [12.11, -86.27], [12.18, -86.22], [12.05, -86.35], [12.25, -86.18], [11.98, -86.42],
  [9.93, -84.08], [9.98, -84.02], [9.88, -84.15], [10.05, -83.95], [9.82, -84.22],
  [8.98, -79.52], [9.05, -79.45], [8.92, -79.58], [9.12, -79.42], [8.85, -79.65],
  [17.50, -88.20], [17.55, -88.12], [17.42, -88.28], [17.62, -88.15], [17.35, -88.35],
  [18.00, -76.80], [18.08, -76.72], [17.92, -76.88], [18.15, -76.65], [17.85, -76.95],
  // South America
  [-23.55, -46.63], [-23.48, -46.55], [-23.62, -46.72], [-23.42, -46.48], [-23.68, -46.78],
  [-23.52, -46.68], [-23.58, -46.58], [-23.45, -46.75], [-23.72, -46.52], [-23.38, -46.82],
  [-22.91, -43.17], [-22.85, -43.22], [-22.98, -43.08], [-22.78, -43.28], [-23.05, -43.02],
  [-22.88, -43.25], [-22.95, -43.12], [-22.82, -43.32], [-23.02, -43.05], [-22.72, -43.38],
  [-34.60, -58.38], [-34.55, -58.32], [-34.65, -58.45], [-34.48, -58.42], [-34.72, -58.52],
  [-34.58, -58.42], [-34.52, -58.48], [-34.68, -58.32], [-34.45, -58.55], [-34.75, -58.28],
  [-33.45, -70.67], [-33.38, -70.58], [-33.52, -70.75], [-33.32, -70.62], [-33.58, -70.82],
  [-12.05, -77.04], [-12.12, -77.12], [-11.98, -76.95], [-12.18, -77.18], [-11.92, -76.88],
  [4.71, -74.07], [4.78, -74.02], [4.65, -74.15], [4.85, -73.95], [4.58, -74.22],
  [10.49, -66.88], [10.55, -66.82], [10.42, -66.95], [10.62, -66.75], [10.35, -67.02],
  [-0.18, -78.47], [-0.12, -78.42], [-0.25, -78.55], [-0.05, -78.38], [-0.32, -78.62],
  [-16.50, -68.15], [-16.42, -68.08], [-16.58, -68.22], [-16.35, -68.02], [-16.65, -68.28],
  [-25.27, -57.64], [-25.22, -57.58], [-25.35, -57.72], [-25.15, -57.52], [-25.42, -57.78],
  [-34.88, -56.17], [-34.82, -56.12], [-34.95, -56.25], [-34.75, -56.05], [-35.02, -56.32],
  [5.02, -60.73], [5.08, -60.68], [4.95, -60.78], [5.15, -60.62], [4.88, -60.85],
  [-3.74, -38.52], [-3.68, -38.45], [-3.82, -38.58], [-3.62, -38.38], [-3.88, -38.65],
  [-19.92, -43.94], [-19.85, -43.88], [-19.98, -44.02], [-19.78, -43.82], [-20.05, -44.08],
  [-30.03, -51.23], [-29.95, -51.18], [-30.12, -51.32], [-29.88, -51.12], [-30.18, -51.38],
  [-1.46, -48.50], [-1.38, -48.42], [-1.52, -48.58], [-1.32, -48.35], [-1.58, -48.65],
  [-8.05, -34.88], [-7.98, -34.82], [-8.12, -34.95], [-7.92, -34.75], [-8.18, -35.02],
  [-27.59, -48.55], [-27.52, -48.48], [-27.68, -48.62], [-27.45, -48.42], [-27.75, -48.68],
  [-15.78, -47.93], [-15.72, -47.85], [-15.85, -48.02], [-15.65, -47.78], [-15.92, -48.08],
  // Europe - Western
  [51.51, -0.13], [51.48, -0.08], [51.55, -0.18], [51.42, -0.22], [51.58, -0.05],
  [51.52, 0.08], [51.45, -0.28], [51.62, 0.02], [51.38, -0.15], [51.68, -0.12],
  [48.86, 2.35], [48.82, 2.28], [48.92, 2.42], [48.78, 2.22], [48.98, 2.48],
  [48.88, 2.52], [48.75, 2.38], [49.02, 2.28], [48.72, 2.55], [49.08, 2.18],
  [52.52, 13.41], [52.48, 13.35], [52.58, 13.48], [52.42, 13.28], [52.62, 13.55],
  [52.55, 13.58], [52.38, 13.42], [52.68, 13.32], [52.35, 13.62], [52.72, 13.22],
  [41.90, 12.50], [41.85, 12.42], [41.95, 12.58], [41.78, 12.35], [42.02, 12.65],
  [40.42, -3.70], [40.38, -3.78], [40.48, -3.62], [40.32, -3.85], [40.55, -3.55],
  [52.37, 4.90], [52.32, 4.82], [52.42, 4.98], [52.28, 4.75], [52.48, 5.05],
  [50.85, 4.35], [50.82, 4.28], [50.88, 4.42], [50.78, 4.22], [50.92, 4.48],
  [46.20, 6.14], [46.25, 6.22], [46.15, 6.08], [46.32, 6.28], [46.08, 5.98],
  [48.21, 16.37], [48.15, 16.28], [48.28, 16.45], [48.08, 16.22], [48.35, 16.52],
  [47.50, 19.04], [47.45, 18.95], [47.55, 19.12], [47.38, 18.88], [47.62, 19.22],
  [50.08, 14.44], [50.02, 14.35], [50.15, 14.52], [49.95, 14.28], [50.22, 14.58],
  [52.23, 21.01], [52.18, 20.92], [52.28, 21.08], [52.12, 20.85], [52.35, 21.18],
  [59.33, 18.07], [59.28, 17.98], [59.38, 18.15], [59.22, 17.92], [59.45, 18.22],
  [59.91, 10.75], [59.85, 10.68], [59.98, 10.82], [59.78, 10.62], [60.05, 10.88],
  [55.68, 12.57], [55.62, 12.48], [55.75, 12.65], [55.55, 12.42], [55.82, 12.72],
  [60.17, 24.94], [60.12, 24.85], [60.22, 25.02], [60.05, 24.78], [60.28, 25.08],
  [53.35, -6.26], [53.28, -6.32], [53.42, -6.18], [53.22, -6.38], [53.48, -6.12],
  [55.95, -3.19], [55.88, -3.25], [56.02, -3.12], [55.82, -3.32], [56.08, -3.05],
  [53.48, -2.24], [53.42, -2.32], [53.55, -2.15], [53.35, -2.38], [53.62, -2.08],
  [51.45, -2.59], [51.38, -2.65], [51.52, -2.52], [51.32, -2.72], [51.58, -2.45],
  [45.46, 9.19], [45.52, 9.28], [45.38, 9.12], [45.58, 9.35], [45.32, 9.05],
  [43.77, 11.25], [43.72, 11.18], [43.82, 11.32], [43.65, 11.12], [43.88, 11.38],
  [44.41, 8.95], [44.35, 8.88], [44.48, 9.02], [44.28, 8.82], [44.55, 9.08],
  [45.44, 12.32], [45.38, 12.25], [45.52, 12.38], [45.32, 12.18], [45.58, 12.45],
  [40.85, 14.27], [40.78, 14.18], [40.92, 14.35], [40.72, 14.12], [40.98, 14.42],
  [41.39, 2.17], [41.32, 2.08], [41.45, 2.25], [41.25, 2.02], [41.52, 2.32],
  [39.47, -0.38], [39.42, -0.45], [39.52, -0.32], [39.35, -0.52], [39.58, -0.25],
  [37.39, -5.99], [37.32, -6.05], [37.45, -5.92], [37.25, -6.12], [37.52, -5.85],
  [38.72, -9.14], [38.65, -9.22], [38.78, -9.08], [38.58, -9.28], [38.85, -9.02],
  [41.16, -8.63], [41.22, -8.55], [41.08, -8.72], [41.28, -8.48], [41.02, -8.78],
  [43.30, -1.98], [43.25, -2.05], [43.35, -1.92], [43.18, -2.12], [43.42, -1.85],
  [48.58, 7.75], [48.52, 7.68], [48.65, 7.82], [48.45, 7.62], [48.72, 7.88],
  [50.94, 6.96], [50.88, 6.88], [51.02, 7.02], [50.82, 6.82], [51.08, 7.08],
  [53.55, 9.99], [53.48, 9.92], [53.62, 10.08], [53.42, 9.85], [53.68, 10.15],
  [48.14, 11.58], [48.08, 11.52], [48.22, 11.65], [48.02, 11.45], [48.28, 11.72],
  [51.23, 6.78], [51.18, 6.72], [51.28, 6.85], [51.12, 6.65], [51.35, 6.92],
  [49.45, 11.08], [49.38, 11.02], [49.52, 11.15], [49.32, 10.95], [49.58, 11.22],
  [51.34, 12.37], [51.28, 12.32], [51.42, 12.45], [51.22, 12.25], [51.48, 12.52],
  // Europe - Eastern
  [55.76, 37.62], [55.68, 37.52], [55.82, 37.72], [55.62, 37.42], [55.88, 37.82],
  [55.72, 37.78], [55.85, 37.48], [55.58, 37.88], [55.92, 37.38], [55.52, 37.95],
  [59.93, 30.34], [59.88, 30.25], [59.98, 30.42], [59.82, 30.18], [60.05, 30.52],
  [56.84, 60.61], [56.78, 60.52], [56.92, 60.68], [56.72, 60.45], [56.98, 60.75],
  [55.03, 82.92], [54.95, 82.85], [55.12, 83.02], [54.88, 82.78], [55.18, 83.08],
  [54.99, 73.37], [54.92, 73.28], [55.08, 73.45], [54.85, 73.22], [55.15, 73.52],
  [53.20, 50.15], [53.12, 50.08], [53.28, 50.22], [53.05, 50.02], [53.35, 50.28],
  [51.67, 39.18], [51.62, 39.12], [51.75, 39.25], [51.55, 39.05], [51.82, 39.32],
  [47.22, 39.72], [47.15, 39.65], [47.28, 39.78], [47.08, 39.58], [47.35, 39.85],
  [48.47, 35.04], [48.42, 34.95], [48.52, 35.12], [48.35, 34.88], [48.58, 35.18],
  [50.45, 30.52], [50.38, 30.45], [50.52, 30.58], [50.32, 30.38], [50.58, 30.65],
  [49.84, 24.03], [49.78, 23.95], [49.92, 24.12], [49.72, 23.88], [49.98, 24.18],
  [46.48, 30.73], [46.42, 30.65], [46.55, 30.82], [46.35, 30.58], [46.62, 30.88],
  [44.43, 26.10], [44.38, 26.02], [44.48, 26.18], [44.32, 25.95], [44.55, 26.25],
  [42.70, 23.32], [42.65, 23.25], [42.75, 23.38], [42.58, 23.18], [42.82, 23.45],
  [44.82, 20.46], [44.75, 20.38], [44.88, 20.52], [44.68, 20.32], [44.95, 20.58],
  [45.81, 15.98], [45.75, 15.92], [45.88, 16.05], [45.68, 15.85], [45.95, 16.12],
  [46.06, 14.51], [46.02, 14.45], [46.12, 14.58], [45.95, 14.38], [46.18, 14.65],
  // Asia - East
  [35.68, 139.69], [35.62, 139.62], [35.75, 139.78], [35.55, 139.55], [35.82, 139.85],
  [35.72, 139.82], [35.58, 139.68], [35.85, 139.58], [35.48, 139.92], [35.92, 139.52],
  [34.69, 135.50], [34.62, 135.42], [34.75, 135.58], [34.55, 135.35], [34.82, 135.65],
  [35.18, 136.91], [35.12, 136.85], [35.25, 136.98], [35.05, 136.78], [35.32, 137.05],
  [43.06, 141.35], [43.02, 141.28], [43.12, 141.42], [42.95, 141.22], [43.18, 141.48],
  [33.59, 130.40], [33.52, 130.32], [33.65, 130.48], [33.45, 130.25], [33.72, 130.55],
  [31.23, 121.47], [31.18, 121.42], [31.28, 121.52], [31.12, 121.35], [31.35, 121.58],
  [31.25, 121.55], [31.32, 121.38], [31.08, 121.62], [31.38, 121.32], [31.02, 121.68],
  [39.90, 116.41], [39.85, 116.35], [39.95, 116.48], [39.78, 116.28], [40.02, 116.55],
  [39.88, 116.52], [39.92, 116.32], [39.75, 116.58], [40.05, 116.25], [39.68, 116.65],
  [23.13, 113.26], [23.08, 113.18], [23.18, 113.32], [23.02, 113.12], [23.25, 113.38],
  [22.54, 114.06], [22.48, 113.98], [22.62, 114.12], [22.42, 113.92], [22.68, 114.18],
  [30.57, 104.07], [30.52, 103.98], [30.62, 104.15], [30.45, 103.92], [30.68, 104.22],
  [29.56, 106.55], [29.48, 106.48], [29.65, 106.62], [29.42, 106.42], [29.72, 106.68],
  [34.26, 108.94], [34.18, 108.85], [34.32, 109.02], [34.12, 108.78], [34.38, 109.08],
  [36.06, 120.38], [35.98, 120.32], [36.12, 120.45], [35.92, 120.25], [36.18, 120.52],
  [32.06, 118.78], [31.98, 118.72], [32.12, 118.85], [31.92, 118.65], [32.18, 118.92],
  [30.29, 120.16], [30.22, 120.08], [30.35, 120.22], [30.15, 120.02], [30.42, 120.28],
  [28.23, 112.94], [28.18, 112.88], [28.28, 113.02], [28.12, 112.82], [28.35, 113.08],
  [23.02, 113.75], [22.95, 113.68], [23.08, 113.82], [22.88, 113.62], [23.15, 113.88],
  [25.04, 102.71], [24.98, 102.65], [25.12, 102.78], [24.92, 102.58], [25.18, 102.85],
  [22.82, 108.32], [22.75, 108.25], [22.88, 108.38], [22.68, 108.18], [22.95, 108.45],
  [38.04, 114.48], [37.98, 114.42], [38.12, 114.55], [37.92, 114.35], [38.18, 114.62],
  [37.87, 112.55], [37.82, 112.48], [37.92, 112.62], [37.75, 112.42], [37.98, 112.68],
  [41.80, 123.43], [41.72, 123.35], [41.88, 123.52], [41.65, 123.28], [41.95, 123.58],
  [45.75, 126.65], [45.68, 126.58], [45.82, 126.72], [45.62, 126.52], [45.88, 126.78],
  [43.88, 125.32], [43.82, 125.25], [43.95, 125.38], [43.75, 125.18], [44.02, 125.45],
  [40.84, 111.75], [40.78, 111.68], [40.92, 111.82], [40.72, 111.62], [40.98, 111.88],
  [22.28, 114.16], [22.22, 114.08], [22.35, 114.22], [22.15, 114.02], [22.42, 114.28],
  [22.20, 113.55], [22.15, 113.48], [22.28, 113.62], [22.08, 113.42], [22.35, 113.68],
  [25.03, 121.57], [24.98, 121.52], [25.08, 121.62], [24.92, 121.45], [25.15, 121.68],
  [22.62, 120.31], [22.55, 120.25], [22.68, 120.38], [22.48, 120.18], [22.75, 120.45],
  [24.15, 120.67], [24.08, 120.62], [24.22, 120.75], [24.02, 120.55], [24.28, 120.82],
  [37.57, 126.98], [37.52, 126.92], [37.62, 127.05], [37.45, 126.85], [37.68, 127.12],
  [35.18, 129.08], [35.12, 129.02], [35.25, 129.15], [35.05, 128.95], [35.32, 129.22],
  [35.87, 128.60], [35.82, 128.52], [35.92, 128.68], [35.75, 128.45], [35.98, 128.75],
  [21.03, 105.85], [20.98, 105.78], [21.08, 105.92], [20.92, 105.72], [21.15, 105.98],
  [10.82, 106.63], [10.75, 106.55], [10.88, 106.72], [10.68, 106.48], [10.95, 106.78],
  [16.07, 108.22], [16.02, 108.15], [16.12, 108.28], [15.95, 108.08], [16.18, 108.35],
  [13.75, 100.50], [13.68, 100.42], [13.82, 100.58], [13.62, 100.35], [13.88, 100.65],
  [18.79, 98.98], [18.72, 98.92], [18.85, 99.05], [18.65, 98.85], [18.92, 99.12],
  [14.60, 121.00], [14.52, 120.92], [14.68, 121.08], [14.45, 120.85], [14.75, 121.15],
  [10.31, 123.89], [10.25, 123.82], [10.38, 123.95], [10.18, 123.75], [10.45, 124.02],
  [7.07, 125.61], [7.02, 125.55], [7.12, 125.68], [6.95, 125.48], [7.18, 125.75],
  [3.14, 101.69], [3.08, 101.62], [3.22, 101.75], [3.02, 101.55], [3.28, 101.82],
  [1.35, 103.82], [1.28, 103.75], [1.42, 103.88], [1.22, 103.68], [1.48, 103.95],
  [5.41, 100.33], [5.35, 100.28], [5.48, 100.38], [5.28, 100.22], [5.55, 100.45],
  [-6.21, 106.85], [-6.15, 106.78], [-6.28, 106.92], [-6.08, 106.72], [-6.35, 106.98],
  [-7.25, 112.75], [-7.18, 112.68], [-7.32, 112.82], [-7.12, 112.62], [-7.38, 112.88],
  [-6.97, 110.42], [-6.92, 110.35], [-7.02, 110.48], [-6.85, 110.28], [-7.08, 110.55],
  [-7.80, 110.36], [-7.75, 110.28], [-7.85, 110.42], [-7.68, 110.22], [-7.92, 110.48],
  // Asia - South
  [28.61, 77.21], [28.55, 77.12], [28.68, 77.28], [28.48, 77.05], [28.75, 77.35],
  [28.58, 77.32], [28.72, 77.08], [28.42, 77.38], [28.78, 77.02], [28.38, 77.42],
  [19.08, 72.88], [19.02, 72.82], [19.15, 72.95], [18.95, 72.75], [19.22, 73.02],
  [19.12, 72.98], [18.98, 72.78], [19.28, 72.85], [18.88, 73.05], [19.35, 72.72],
  [13.08, 80.27], [13.02, 80.22], [13.15, 80.32], [12.95, 80.15], [13.22, 80.38],
  [22.57, 88.36], [22.52, 88.28], [22.62, 88.42], [22.45, 88.22], [22.68, 88.48],
  [12.97, 77.59], [12.92, 77.52], [13.02, 77.65], [12.85, 77.45], [13.08, 77.72],
  [17.39, 78.49], [17.32, 78.42], [17.45, 78.55], [17.25, 78.35], [17.52, 78.62],
  [23.02, 72.57], [22.95, 72.52], [23.08, 72.62], [22.88, 72.45], [23.15, 72.68],
  [18.52, 73.86], [18.45, 73.78], [18.58, 73.92], [18.38, 73.72], [18.65, 73.98],
  [26.85, 80.95], [26.78, 80.88], [26.92, 81.02], [26.72, 80.82], [26.98, 81.08],
  [21.17, 72.83], [21.12, 72.78], [21.22, 72.88], [21.05, 72.72], [21.28, 72.95],
  [26.92, 75.79], [26.85, 75.72], [26.98, 75.85], [26.78, 75.65], [27.05, 75.92],
  [24.86, 67.01], [24.78, 66.95], [24.92, 67.08], [24.72, 66.88], [24.98, 67.15],
  [31.56, 74.35], [31.48, 74.28], [31.62, 74.42], [31.42, 74.22], [31.68, 74.48],
  [33.69, 73.06], [33.62, 72.98], [33.75, 73.12], [33.55, 72.92], [33.82, 73.18],
  // Middle East
  [25.28, 55.30], [25.22, 55.22], [25.35, 55.38], [25.15, 55.15], [25.42, 55.45],
  [24.47, 54.37], [24.42, 54.28], [24.52, 54.45], [24.35, 54.22], [24.58, 54.52],
  [25.29, 51.53], [25.22, 51.45], [25.35, 51.58], [25.15, 51.38], [25.42, 51.65],
  [26.23, 50.59], [26.18, 50.52], [26.28, 50.65], [26.12, 50.45], [26.35, 50.72],
  [29.38, 47.99], [29.32, 47.92], [29.45, 48.05], [29.25, 47.85], [29.52, 48.12],
  [24.71, 46.68], [24.65, 46.62], [24.78, 46.75], [24.58, 46.55], [24.85, 46.82],
  [21.49, 39.19], [21.42, 39.12], [21.55, 39.25], [21.35, 39.05], [21.62, 39.32],
  [23.59, 58.38], [23.52, 58.32], [23.65, 58.45], [23.45, 58.25], [23.72, 58.52],
  [33.31, 44.37], [33.25, 44.28], [33.38, 44.45], [33.18, 44.22], [33.45, 44.52],
  [31.95, 35.93], [31.88, 35.85], [32.02, 36.02], [31.82, 35.78], [32.08, 36.08],
  [32.09, 34.77], [32.02, 34.72], [32.15, 34.82], [31.95, 34.65], [32.22, 34.88],
  [31.77, 35.22], [31.72, 35.15], [31.82, 35.28], [31.65, 35.08], [31.88, 35.35],
  [33.89, 35.50], [33.82, 35.42], [33.95, 35.58], [33.75, 35.35], [34.02, 35.65],
  [33.51, 36.29], [33.45, 36.22], [33.58, 36.35], [33.38, 36.15], [33.65, 36.42],
  // Africa - North
  [30.04, 31.24], [29.98, 31.18], [30.12, 31.32], [29.92, 31.08], [30.18, 31.38],
  [30.08, 31.38], [29.95, 31.12], [30.22, 31.28], [29.88, 31.45], [30.28, 31.05],
  [31.20, 29.92], [31.15, 29.85], [31.28, 29.98], [31.08, 29.78], [31.35, 30.05],
  [27.18, 31.17], [27.12, 31.08], [27.25, 31.25], [27.05, 31.02], [27.32, 31.32],
  [36.75, 3.06], [36.68, 2.98], [36.82, 3.12], [36.62, 2.92], [36.88, 3.18],
  [33.59, -7.62], [33.52, -7.68], [33.65, -7.55], [33.45, -7.75], [33.72, -7.48],
  [34.03, -6.84], [33.98, -6.92], [34.08, -6.78], [33.92, -6.98], [34.15, -6.72],
  [31.63, -8.01], [31.58, -8.08], [31.68, -7.95], [31.52, -8.15], [31.75, -7.88],
  [36.81, 10.18], [36.75, 10.12], [36.88, 10.25], [36.68, 10.05], [36.95, 10.32],
  [32.88, 13.19], [32.82, 13.12], [32.95, 13.25], [32.75, 13.05], [33.02, 13.32],
  [15.55, 32.53], [15.48, 32.45], [15.62, 32.58], [15.42, 32.38], [15.68, 32.65],
  [9.03, 38.75], [8.98, 38.68], [9.08, 38.82], [8.92, 38.62], [9.15, 38.88],
  // Africa - West
  [6.52, 3.38], [6.45, 3.32], [6.58, 3.45], [6.38, 3.25], [6.65, 3.52],
  [6.48, 3.45], [6.55, 3.28], [6.35, 3.55], [6.62, 3.18], [6.28, 3.62],
  [9.06, 7.49], [8.98, 7.42], [9.12, 7.55], [8.92, 7.35], [9.18, 7.62],
  [12.00, 8.52], [11.92, 8.45], [12.08, 8.58], [11.85, 8.38], [12.15, 8.65],
  [6.69, -1.62], [6.62, -1.68], [6.75, -1.55], [6.55, -1.75], [6.82, -1.48],
  [5.56, -0.20], [5.48, -0.28], [5.62, -0.12], [5.42, -0.35], [5.68, -0.05],
  [5.35, -4.01], [5.28, -4.08], [5.42, -3.95], [5.22, -4.15], [5.48, -3.88],
  [14.69, -17.44], [14.62, -17.52], [14.75, -17.38], [14.55, -17.58], [14.82, -17.32],
  [12.65, -8.00], [12.58, -8.08], [12.72, -7.92], [12.52, -8.15], [12.78, -7.85],
  // Africa - East
  [-1.29, 36.82], [-1.22, 36.75], [-1.35, 36.88], [-1.15, 36.68], [-1.42, 36.95],
  [-6.17, 35.74], [-6.12, 35.68], [-6.22, 35.82], [-6.05, 35.62], [-6.28, 35.88],
  [-4.05, 39.66], [-3.98, 39.58], [-4.12, 39.72], [-3.92, 39.52], [-4.18, 39.78],
  [0.32, 32.58], [0.25, 32.52], [0.38, 32.65], [0.18, 32.45], [0.45, 32.72],
  [-15.79, 35.01], [-15.72, 34.95], [-15.85, 35.08], [-15.65, 34.88], [-15.92, 35.15],
  [-17.83, 31.05], [-17.78, 30.98], [-17.88, 31.12], [-17.72, 30.92], [-17.95, 31.18],
  [-18.91, 47.52], [-18.85, 47.45], [-18.98, 47.58], [-18.78, 47.38], [-19.05, 47.65],
  // Africa - South
  [-33.93, 18.42], [-33.88, 18.35], [-33.98, 18.48], [-33.82, 18.28], [-34.05, 18.55],
  [-33.95, 18.52], [-33.85, 18.38], [-34.02, 18.28], [-33.78, 18.58], [-34.08, 18.22],
  [-29.86, 31.02], [-29.78, 30.95], [-29.92, 31.08], [-29.72, 30.88], [-29.98, 31.15],
  [-26.20, 28.05], [-26.12, 27.98], [-26.28, 28.12], [-26.05, 27.92], [-26.35, 28.18],
  [-25.75, 28.19], [-25.68, 28.12], [-25.82, 28.25], [-25.62, 28.05], [-25.88, 28.32],
  [-33.96, 25.60], [-33.88, 25.52], [-34.02, 25.68], [-33.82, 25.45], [-34.08, 25.75],
  [-22.57, 17.08], [-22.52, 17.02], [-22.62, 17.15], [-22.45, 16.95], [-22.68, 17.22],
  [-8.84, 13.23], [-8.78, 13.18], [-8.92, 13.28], [-8.72, 13.12], [-8.98, 13.35],
  [-15.42, 28.28], [-15.35, 28.22], [-15.48, 28.35], [-15.28, 28.15], [-15.55, 28.42],
  // Australia & New Zealand
  [-33.87, 151.21], [-33.82, 151.15], [-33.92, 151.28], [-33.78, 151.08], [-33.98, 151.35],
  [-33.85, 151.32], [-33.92, 151.08], [-33.75, 151.38], [-33.98, 151.02], [-33.68, 151.42],
  [-37.81, 144.96], [-37.75, 144.88], [-37.88, 145.05], [-37.68, 144.82], [-37.95, 145.12],
  [-37.78, 145.08], [-37.85, 144.82], [-37.62, 145.15], [-37.92, 144.75], [-37.55, 145.22],
  [-27.47, 153.03], [-27.42, 152.95], [-27.52, 153.08], [-27.35, 152.88], [-27.58, 153.15],
  [-31.95, 115.86], [-31.88, 115.78], [-32.02, 115.92], [-31.82, 115.72], [-32.08, 115.98],
  [-34.93, 138.60], [-34.88, 138.52], [-34.98, 138.68], [-34.82, 138.45], [-35.05, 138.75],
  [-12.46, 130.84], [-12.38, 130.78], [-12.52, 130.92], [-12.32, 130.72], [-12.58, 130.98],
  [-42.88, 147.33], [-42.82, 147.25], [-42.95, 147.38], [-42.75, 147.18], [-43.02, 147.45],
  [-35.28, 149.13], [-35.22, 149.05], [-35.35, 149.22], [-35.15, 148.98], [-35.42, 149.28],
  [-36.85, 174.76], [-36.78, 174.68], [-36.92, 174.82], [-36.72, 174.62], [-36.98, 174.88],
  [-41.29, 174.78], [-41.22, 174.72], [-41.35, 174.85], [-41.15, 174.65], [-41.42, 174.92],
  [-43.53, 172.64], [-43.48, 172.58], [-43.58, 172.72], [-43.42, 172.52], [-43.65, 172.78],
  // Additional dense urban areas - China coastal cities
  [24.48, 118.09], [26.07, 119.30], [27.99, 120.68], [28.69, 121.49], [24.88, 118.68],
  [25.05, 117.28], [23.35, 116.68], [21.27, 110.35], [20.02, 110.35], [22.38, 113.58],
  // India additional cities
  [15.35, 75.12], [16.51, 80.62], [11.65, 78.16], [10.79, 78.69], [9.92, 78.12],
  [8.52, 76.95], [11.02, 76.97], [12.91, 74.86], [15.49, 73.82], [18.92, 72.82],
  [20.92, 77.78], [21.75, 72.15], [23.25, 77.42], [24.58, 73.69], [25.18, 75.78],
  // Japan additional cities
  [34.98, 138.39], [35.62, 140.12], [36.35, 139.45], [35.02, 136.97], [34.23, 135.17],
  [34.73, 134.82], [33.25, 131.61], [32.75, 129.87], [35.45, 137.58], [34.72, 137.72],
  // Southeast Asia additional
  [1.28, 103.85], [2.92, 101.66], [5.98, 116.07], [6.12, 102.24], [4.88, 115.05],
  [13.35, 100.49], [7.55, 99.60], [9.98, 99.02], [16.47, 102.83], [14.97, 102.10],
  // Middle East additional
  [31.78, 35.22], [32.08, 34.85], [35.68, 51.39], [34.32, 47.07], [30.42, 48.00],
  [22.28, 39.12], [24.68, 46.72], [26.42, 50.08], [25.92, 55.95], [24.45, 54.38],
];


function CityLights() {
  const groupRef = useRef<THREE.Group>(null);
  
  const pointsGeometry = useMemo(() => {
    const radius = 2.03;
    const positions = new Float32Array(cityLights.length * 3);
    
    cityLights.forEach(([lat, lon], i) => {
      const vec = latLonToVector3(lat, lon, radius);
      positions[i * 3] = vec.x;
      positions[i * 3 + 1] = vec.y;
      positions[i * 3 + 2] = vec.z;
    });
    
    const geometry = new THREE.BufferGeometry();
    geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
    return geometry;
  }, []);
  
  useFrame((state, delta) => {
    if (groupRef.current) {
      groupRef.current.rotation.y += delta * 0.08;
    }
  });

  return (
    <group ref={groupRef}>
      <points geometry={pointsGeometry}>
        <pointsMaterial
          size={0.025}
          color="#fbbf24"
          transparent
          opacity={0.6}
          sizeAttenuation
        />
      </points>
    </group>
  );
}

// Network connection pairs between major cities [fromIndex, toIndex]
const networkConnections: [number, number][] = [
  // === NORTHERN HEMISPHERE ===
  // Transatlantic (North America - Europe)
  [0, 143], [8, 145], [11, 144],
  // Trans-Pacific (North America - Asia)
  [1, 157], [7, 160], [8, 165],
  // Europe-Asia
  [143, 157], [144, 160], [152, 157],
  
  // === SOUTHERN HEMISPHERE ===
  // South America - Africa
  [67, 205], [68, 196], [69, 200], [70, 205],
  // South America - Australia/NZ
  [67, 208], [69, 209], [68, 210], [70, 211],
  // Africa - Australia
  [205, 208], [200, 209], [196, 208], [201, 210],
  // South America internal
  [67, 69], [68, 70], [69, 71], [67, 72],
  // Africa internal (south)
  [205, 206], [200, 201], [202, 205], [203, 207],
  // Australia/NZ internal
  [208, 209], [208, 210], [209, 211], [210, 212],
  
  // === CROSS-HEMISPHERE ===
  // North America - South America
  [0, 67], [1, 69], [13, 68], [50, 67],
  // Europe - Africa
  [143, 190], [144, 196], [145, 200], [146, 205],
  // Asia - Australia
  [160, 208], [157, 209], [170, 208], [171, 210],
  // Middle East - Africa
  [185, 190], [185, 196], [181, 200],
  // Asia - South
  [171, 205], [160, 200], [165, 208],
];

function NetworkLines() {
  const groupRef = useRef<THREE.Group>(null);
  const pulsesRef = useRef<THREE.Mesh[]>([]);
  const pulseProgressRef = useRef<number[]>(networkConnections.map(() => Math.random()));
  
  const curves = useMemo(() => {
    const radius = 2.04;
    const curvesList: THREE.CurvePath<THREE.Vector3>[] = [];
    
    networkConnections.forEach(([fromIdx, toIdx]) => {
      if (fromIdx >= cityLights.length || toIdx >= cityLights.length) return;
      
      const [lat1, lon1] = cityLights[fromIdx];
      const [lat2, lon2] = cityLights[toIdx];
      
      const start = latLonToVector3(lat1, lon1, radius);
      const end = latLonToVector3(lat2, lon2, radius);
      
      const distance = start.distanceTo(end);
      const arcHeight = 0.4 + distance * 0.25;
      
      const mid = new THREE.Vector3().addVectors(start, end).multiplyScalar(0.5);
      mid.normalize().multiplyScalar(radius + arcHeight);
      
      const curve = new THREE.QuadraticBezierCurve3(start, mid, end);
      const curvePath = new THREE.CurvePath<THREE.Vector3>();
      curvePath.add(curve);
      curvesList.push(curvePath);
    });
    
    return curvesList;
  }, []);
  
  useFrame((state, delta) => {
    if (groupRef.current) {
      groupRef.current.rotation.y += delta * 0.08;
    }
    
    pulseProgressRef.current.forEach((progress, idx) => {
      if (idx >= curves.length || !pulsesRef.current[idx]) return;
      
      const speed = 0.15 + (idx % 5) * 0.05;
      pulseProgressRef.current[idx] = (progress + delta * speed) % 1;
      
      const point = curves[idx].getPoint(pulseProgressRef.current[idx]);
      pulsesRef.current[idx].position.set(point.x, point.y, point.z);
    });
  });

  return (
    <group ref={groupRef}>
      {curves.map((curvePath, idx) => {
        const points = curvePath.getPoints(30);
        const lineGeometry = new THREE.BufferGeometry().setFromPoints(points);
        return (
          <primitive key={`line-${idx}`} object={new THREE.Line(
            lineGeometry,
            new THREE.LineBasicMaterial({ color: '#22d3ee', transparent: true, opacity: 0.5, linewidth: 2 })
          )} />
        );
      })}
      {curves.map((_, idx) => (
        <mesh 
          key={`pulse-${idx}`} 
          ref={(el) => { if (el) pulsesRef.current[idx] = el; }}
        >
          <sphereGeometry args={[0.012, 8, 8]} />
          <meshBasicMaterial color="#67e8f9" transparent opacity={1} />
        </mesh>
      ))}
    </group>
  );
}

function latLonToVector3(lat: number, lon: number, radius: number): THREE.Vector3 {
  const phi = (90 - lat) * (Math.PI / 180);
  const theta = (lon + 180) * (Math.PI / 180);
  
  const x = -radius * Math.sin(phi) * Math.cos(theta);
  const y = radius * Math.cos(phi);
  const z = radius * Math.sin(phi) * Math.sin(theta);
  
  return new THREE.Vector3(x, y, z);
}

function createContinentMesh(coords: number[][], radius: number): THREE.Mesh {
  const vertices: number[] = [];
  const indices: number[] = [];
  
  // Create vertices on sphere surface
  coords.forEach(([lat, lon]) => {
    const vec = latLonToVector3(lat, lon, radius);
    vertices.push(vec.x, vec.y, vec.z);
  });
  
  // Simple fan triangulation from first vertex
  for (let i = 1; i < coords.length - 1; i++) {
    indices.push(0, i, i + 1);
  }
  
  const geometry = new THREE.BufferGeometry();
  geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
  geometry.setIndex(indices);
  geometry.computeVertexNormals();
  
  const material = new THREE.MeshBasicMaterial({
    color: '#0ea5e9',
    transparent: true,
    opacity: 0.08,
    side: THREE.FrontSide,
    depthWrite: false,
  });
  
  return new THREE.Mesh(geometry, material);
}

function ContinentOutlines() {
  const groupRef = useRef<THREE.Group>(null);
  
  const { lineObjects, fillMeshes } = useMemo(() => {
    const outlineRadius = 2.02;
    const fillRadius = 2.01;
    const lines: THREE.Line[] = [];
    const fills: THREE.Mesh[] = [];
    
    Object.values(continentOutlines).forEach((coords) => {
      // Create outline
      const points: THREE.Vector3[] = [];
      coords.forEach(([lat, lon]) => {
        points.push(latLonToVector3(lat, lon, outlineRadius));
      });
      const lineGeometry = new THREE.BufferGeometry().setFromPoints(points);
      const lineMaterial = new THREE.LineBasicMaterial({ color: '#22d3ee', transparent: true, opacity: 0.4 });
      lines.push(new THREE.Line(lineGeometry, lineMaterial));
      
      // Create fill
      fills.push(createContinentMesh(coords, fillRadius));
    });
    
    return { lineObjects: lines, fillMeshes: fills };
  }, []);
  
  useFrame((state, delta) => {
    if (groupRef.current) {
      groupRef.current.rotation.y += delta * 0.08;
    }
  });

  return (
    <group ref={groupRef}>
      {lineObjects.map((line, index) => (
        <primitive key={`line-${index}`} object={line} />
      ))}
      {fillMeshes.map((mesh, index) => (
        <primitive key={`fill-${index}`} object={mesh} />
      ))}
    </group>
  );
}

function Globe() {
  const meshRef = useRef<THREE.Mesh>(null);
  
  useFrame((state, delta) => {
    if (meshRef.current) {
      meshRef.current.rotation.y += delta * 0.08;
    }
  });

  return (
    <Sphere ref={meshRef} args={[2, 64, 64]} position={[0, 0, 0]}>
      <meshStandardMaterial
        color="#0ea5e9"
        wireframe
        transparent
        opacity={0.15}
      />
    </Sphere>
  );
}

function GlobeLines() {
  const meshRef = useRef<THREE.Mesh>(null);
  
  useFrame((state, delta) => {
    if (meshRef.current) {
      meshRef.current.rotation.y += delta * 0.08;
      meshRef.current.rotation.x += delta * 0.015;
    }
  });

  return (
    <Sphere ref={meshRef} args={[2.05, 48, 48]} position={[0, 0, 0]}>
      <meshBasicMaterial
        color="#22d3ee"
        wireframe
        transparent
        opacity={0.08}
      />
    </Sphere>
  );
}

function GlobeGlow() {
  const groupRef = useRef<THREE.Group>(null);
  
  useFrame((state, delta) => {
    if (groupRef.current) {
      groupRef.current.rotation.y += delta * 0.08;
    }
  });

  return (
    <group ref={groupRef}>
      {/* Solid inner sphere to block backside visibility */}
      <Sphere args={[1.85, 32, 32]} position={[0, 0, 0]}>
        <meshBasicMaterial
          color="#0c1929"
          transparent
          opacity={0.85}
        />
      </Sphere>
      {/* Outer glow sphere */}
      <Sphere args={[1.98, 32, 32]} position={[0, 0, 0]}>
        <meshBasicMaterial
          color="#06b6d4"
          transparent
          opacity={0.03}
        />
      </Sphere>
    </group>
  );
}

function NeuralNetwork() {
  const groupRef = useRef<THREE.Group>(null);
  const pulseRef = useRef<number>(0);
  const lineMaterialsRef = useRef<THREE.LineBasicMaterial[]>([]);
  const corePulseRef = useRef<number>(0);
  
  // Core cell refs
  const nucleusRef = useRef<THREE.Mesh>(null);
  const membraneRef = useRef<THREE.Mesh>(null);
  const outerMembraneRef = useRef<THREE.Mesh>(null);
  const haloRing1Ref = useRef<THREE.Mesh>(null);
  const haloRing2Ref = useRef<THREE.Mesh>(null);
  const haloRing3Ref = useRef<THREE.Mesh>(null);
  const dataOrbitRef = useRef<THREE.Group>(null);
  const electronOrbitRef = useRef<THREE.Group>(null);
  const pulseWaveRef = useRef<THREE.Mesh>(null);
  const innerGlowRef = useRef<THREE.Mesh>(null);
  
  const { nodeGeometry, lineObjects, surfaceNodes, coreConnections } = useMemo(() => {
    // Central core at origin
    const corePosition = new THREE.Vector3(0, 0, 0);
    
    // Surface nodes - distributed on the globe surface for connection points
    const surfaceNodeCount = 80;
    const surfaceRadius = 1.95;
    const surfacePositions: THREE.Vector3[] = [];
    
    for (let i = 0; i < surfaceNodeCount; i++) {
      const phi = Math.acos(1 - 2 * (i + 0.5) / surfaceNodeCount);
      const theta = Math.PI * (1 + Math.sqrt(5)) * i;
      
      const x = surfaceRadius * Math.sin(phi) * Math.cos(theta);
      const y = surfaceRadius * Math.sin(phi) * Math.sin(theta);
      const z = surfaceRadius * Math.cos(phi);
      
      surfacePositions.push(new THREE.Vector3(x, y, z));
    }
    
    // Interior relay nodes
    const relayNodeCount = 30;
    const relayPositions: THREE.Vector3[] = [];
    for (let i = 0; i < relayNodeCount; i++) {
      const theta = Math.random() * Math.PI * 2;
      const phi = Math.acos(2 * Math.random() - 1);
      const radius = 0.6 + Math.random() * 1.1;
      
      const x = radius * Math.sin(phi) * Math.cos(theta);
      const y = radius * Math.sin(phi) * Math.sin(theta);
      const z = radius * Math.cos(phi);
      
      relayPositions.push(new THREE.Vector3(x, y, z));
    }
    
    const allNodes = [...surfacePositions, ...relayPositions];
    
    const positions = new Float32Array(allNodes.length * 3);
    allNodes.forEach((pos, i) => {
      positions[i * 3] = pos.x;
      positions[i * 3 + 1] = pos.y;
      positions[i * 3 + 2] = pos.z;
    });
    
    const geo = new THREE.BufferGeometry();
    geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
    
    const lines: THREE.Line[] = [];
    const materials: THREE.LineBasicMaterial[] = [];
    const maxConnectionDistance = 1.0;
    
    for (let i = 0; i < allNodes.length; i++) {
      for (let j = i + 1; j < allNodes.length; j++) {
        const dist = allNodes[i].distanceTo(allNodes[j]);
        if (dist < maxConnectionDistance && Math.random() > 0.5) {
          const lineGeo = new THREE.BufferGeometry().setFromPoints([allNodes[i], allNodes[j]]);
          const material = new THREE.LineBasicMaterial({ 
            color: '#06b6d4', 
            transparent: true, 
            opacity: 0.3 
          });
          materials.push(material);
          lines.push(new THREE.Line(lineGeo, material));
        }
      }
    }
    
    const coreLines: THREE.Line[] = [];
    const coreMaterials: THREE.LineBasicMaterial[] = [];
    
    surfacePositions.forEach((surfacePos) => {
      const midPoint = surfacePos.clone().multiplyScalar(0.45);
      midPoint.x += (Math.random() - 0.5) * 0.25;
      midPoint.y += (Math.random() - 0.5) * 0.25;
      midPoint.z += (Math.random() - 0.5) * 0.25;
      
      const curve = new THREE.QuadraticBezierCurve3(corePosition, midPoint, surfacePos);
      const points = curve.getPoints(25);
      const lineGeo = new THREE.BufferGeometry().setFromPoints(points);
      
      const intensity = 0.2 + Math.random() * 0.2;
      const material = new THREE.LineBasicMaterial({ 
        color: '#22d3ee', 
        transparent: true, 
        opacity: intensity
      });
      coreMaterials.push(material);
      coreLines.push(new THREE.Line(lineGeo, material));
    });
    
    relayPositions.forEach((relayPos) => {
      if (Math.random() > 0.3) {
        const midPoint = relayPos.clone().multiplyScalar(0.25);
        midPoint.x += (Math.random() - 0.5) * 0.15;
        midPoint.y += (Math.random() - 0.5) * 0.15;
        midPoint.z += (Math.random() - 0.5) * 0.15;
        
        const curve = new THREE.QuadraticBezierCurve3(corePosition, midPoint, relayPos);
        const points = curve.getPoints(15);
        const lineGeo = new THREE.BufferGeometry().setFromPoints(points);
        
        const material = new THREE.LineBasicMaterial({ 
          color: '#67e8f9', 
          transparent: true, 
          opacity: 0.25 + Math.random() * 0.25
        });
        coreMaterials.push(material);
        coreLines.push(new THREE.Line(lineGeo, material));
      }
    });
    
    lineMaterialsRef.current = [...materials, ...coreMaterials];
    return { 
      nodeGeometry: geo, 
      lineObjects: lines, 
      surfaceNodes: surfacePositions,
      coreConnections: coreLines 
    };
  }, []);
  
  useFrame((state, delta) => {
    if (groupRef.current) {
      groupRef.current.rotation.y += delta * 0.04;
      groupRef.current.rotation.x += delta * 0.016;
    }
    
    pulseRef.current += delta * 1.5;
    lineMaterialsRef.current.forEach((material, idx) => {
      const wave = Math.sin(pulseRef.current + idx * 0.12) * 0.5 + 0.5;
      const baseOpacity = idx < lineObjects.length ? 0.2 : 0.15;
      material.opacity = baseOpacity + wave * 0.4;
    });
    
    corePulseRef.current += delta;
    const t = corePulseRef.current;
    
    // Nucleus pulsing
    if (nucleusRef.current) {
      const scale = 1.0 + Math.sin(t * 3) * 0.08;
      nucleusRef.current.scale.setScalar(scale);
    }
    
    // Inner glow breathing
    if (innerGlowRef.current) {
      const scale = 1.0 + Math.sin(t * 2.5) * 0.12;
      innerGlowRef.current.scale.setScalar(scale);
      (innerGlowRef.current.material as THREE.MeshBasicMaterial).opacity = 
        0.5 + Math.sin(t * 2) * 0.2;
    }
    
    // Cell membrane pulsing
    if (membraneRef.current) {
      const scale = 1.0 + Math.sin(t * 1.8) * 0.06;
      membraneRef.current.scale.setScalar(scale);
      (membraneRef.current.material as THREE.MeshBasicMaterial).opacity = 
        0.25 + Math.sin(t * 2.2) * 0.1;
    }
    
    // Outer membrane
    if (outerMembraneRef.current) {
      const scale = 1.0 + Math.sin(t * 1.5 + 0.5) * 0.08;
      outerMembraneRef.current.scale.setScalar(scale);
      (outerMembraneRef.current.material as THREE.MeshBasicMaterial).opacity = 
        0.15 + Math.sin(t * 1.8) * 0.08;
    }
    
    // Halo rings rotation
    if (haloRing1Ref.current) {
      haloRing1Ref.current.rotation.z += delta * 0.8;
      haloRing1Ref.current.rotation.x = Math.sin(t * 0.5) * 0.2;
    }
    if (haloRing2Ref.current) {
      haloRing2Ref.current.rotation.z -= delta * 0.6;
      haloRing2Ref.current.rotation.y = Math.sin(t * 0.4) * 0.3;
    }
    if (haloRing3Ref.current) {
      haloRing3Ref.current.rotation.z += delta * 0.4;
      haloRing3Ref.current.rotation.x = Math.cos(t * 0.3) * 0.25;
    }
    
    // Data orbit
    if (dataOrbitRef.current) {
      dataOrbitRef.current.rotation.y += delta * 1.2;
      dataOrbitRef.current.rotation.z = Math.sin(t * 0.7) * 0.1;
    }
    
    // Electron orbit
    if (electronOrbitRef.current) {
      electronOrbitRef.current.rotation.x += delta * 0.9;
      electronOrbitRef.current.rotation.y += delta * 0.5;
    }
    
    // Pulse wave expanding
    if (pulseWaveRef.current) {
      const wavePhase = (t * 0.8) % 1;
      const waveScale = 0.3 + wavePhase * 0.4;
      pulseWaveRef.current.scale.setScalar(waveScale);
      (pulseWaveRef.current.material as THREE.MeshBasicMaterial).opacity = 
        0.4 * (1 - wavePhase);
    }
  });

  return (
    <group ref={groupRef}>
      {/* === INTELLIGENT CELL CORE === */}
      
      {/* Expanding pulse wave */}
      <mesh ref={pulseWaveRef} position={[0, 0, 0]}>
        <sphereGeometry args={[1, 32, 32]} />
        <meshBasicMaterial color="#0ea5e9" transparent opacity={0.2} side={THREE.BackSide} />
      </mesh>
      
      {/* Outer membrane - translucent cell wall */}
      <mesh ref={outerMembraneRef} position={[0, 0, 0]}>
        <sphereGeometry args={[0.5, 48, 48]} />
        <meshBasicMaterial color="#0891b2" transparent opacity={0.15} wireframe />
      </mesh>
      
      {/* Middle membrane */}
      <mesh ref={membraneRef} position={[0, 0, 0]}>
        <sphereGeometry args={[0.38, 40, 40]} />
        <meshBasicMaterial color="#06b6d4" transparent opacity={0.25} />
      </mesh>
      
      {/* Inner glow layer */}
      <mesh ref={innerGlowRef} position={[0, 0, 0]}>
        <sphereGeometry args={[0.28, 32, 32]} />
        <meshBasicMaterial color="#22d3ee" transparent opacity={0.5} />
      </mesh>
      
      {/* Nucleus - bright core */}
      <mesh ref={nucleusRef} position={[0, 0, 0]}>
        <sphereGeometry args={[0.15, 24, 24]} />
        <meshBasicMaterial color="#67e8f9" transparent opacity={0.95} />
      </mesh>
      
      {/* Nucleus center - white hot */}
      <mesh position={[0, 0, 0]}>
        <sphereGeometry args={[0.07, 16, 16]} />
        <meshBasicMaterial color="#ffffff" />
      </mesh>
      
      {/* === ORBITAL RINGS === */}
      
      {/* Halo ring 1 - equatorial */}
      <mesh ref={haloRing1Ref} position={[0, 0, 0]} rotation={[0, 0, 0]}>
        <torusGeometry args={[0.42, 0.008, 16, 100]} />
        <meshBasicMaterial color="#22d3ee" transparent opacity={0.7} />
      </mesh>
      
      {/* Halo ring 2 - tilted */}
      <mesh ref={haloRing2Ref} position={[0, 0, 0]} rotation={[Math.PI / 3, 0, 0]}>
        <torusGeometry args={[0.48, 0.006, 16, 100]} />
        <meshBasicMaterial color="#06b6d4" transparent opacity={0.5} />
      </mesh>
      
      {/* Halo ring 3 - perpendicular */}
      <mesh ref={haloRing3Ref} position={[0, 0, 0]} rotation={[Math.PI / 2, Math.PI / 4, 0]}>
        <torusGeometry args={[0.55, 0.005, 16, 100]} />
        <meshBasicMaterial color="#0ea5e9" transparent opacity={0.4} />
      </mesh>
      
      {/* === ORBITING DATA PARTICLES === */}
      
      {/* Data orbit group */}
      <group ref={dataOrbitRef}>
        {[0, 1, 2, 3, 4, 5].map((i) => {
          const angle = (i / 6) * Math.PI * 2;
          const radius = 0.35;
          return (
            <mesh key={`data-${i}`} position={[
              Math.cos(angle) * radius,
              Math.sin(angle) * radius * 0.3,
              Math.sin(angle) * radius
            ]}>
              <sphereGeometry args={[0.025, 12, 12]} />
              <meshBasicMaterial color="#67e8f9" transparent opacity={0.9} />
            </mesh>
          );
        })}
      </group>
      
      {/* Electron orbit group */}
      <group ref={electronOrbitRef}>
        {[0, 1, 2, 3].map((i) => {
          const angle = (i / 4) * Math.PI * 2;
          const radius = 0.52;
          return (
            <mesh key={`electron-${i}`} position={[
              Math.cos(angle) * radius,
              Math.sin(angle) * radius,
              0
            ]}>
              <sphereGeometry args={[0.018, 10, 10]} />
              <meshBasicMaterial color="#ffffff" transparent opacity={0.85} />
            </mesh>
          );
        })}
      </group>
      
      {/* Additional orbiting sparks */}
      <group rotation={[Math.PI / 6, 0, Math.PI / 4]}>
        {[0, 1, 2].map((i) => {
          const angle = (i / 3) * Math.PI * 2 + corePulseRef.current;
          const radius = 0.45;
          return (
            <mesh key={`spark-${i}`} position={[
              Math.cos(angle) * radius,
              0,
              Math.sin(angle) * radius
            ]}>
              <sphereGeometry args={[0.015, 8, 8]} />
              <meshBasicMaterial color="#a5f3fc" transparent opacity={0.8} />
            </mesh>
          );
        })}
      </group>
      
      {/* === NETWORK NODES AND CONNECTIONS === */}
      
      {/* Surface and relay nodes */}
      <points geometry={nodeGeometry}>
        <pointsMaterial size={0.05} color="#22d3ee" transparent opacity={0.85} sizeAttenuation />
      </points>
      
      {/* Network connections between nodes */}
      {lineObjects.map((line, idx) => (
        <primitive key={`neural-${idx}`} object={line} />
      ))}
      
      {/* Core-to-surface connections */}
      {coreConnections.map((line, idx) => (
        <primitive key={`core-${idx}`} object={line} />
      ))}
    </group>
  );
}

function Particles() {
  const points = useRef<THREE.Points>(null);
  
  const particleCount = 300;
  const positions = new Float32Array(particleCount * 3);
  
  for (let i = 0; i < particleCount; i++) {
    const theta = Math.random() * Math.PI * 2;
    const phi = Math.acos(2 * Math.random() - 1);
    const radius = 2.2 + Math.random() * 0.8;
    
    positions[i * 3] = radius * Math.sin(phi) * Math.cos(theta);
    positions[i * 3 + 1] = radius * Math.sin(phi) * Math.sin(theta);
    positions[i * 3 + 2] = radius * Math.cos(phi);
  }
  
  useFrame((state, delta) => {
    if (points.current) {
      points.current.rotation.y += delta * 0.03;
    }
  });

  return (
    <points ref={points}>
      <bufferGeometry>
        <bufferAttribute
          attach="attributes-position"
          count={particleCount}
          array={positions}
          itemSize={3}
        />
      </bufferGeometry>
      <pointsMaterial
        size={0.015}
        color="#22d3ee"
        transparent
        opacity={0.7}
        sizeAttenuation
      />
    </points>
  );
}

export function SpinningGlobe() {
  const seasonalTilt = useMemo(() => getSeasonalTilt(), []);
  
  return (
    <div className="absolute inset-0">
      <Canvas camera={{ position: [0, 0, 5], fov: 60 }}>
        <ambientLight intensity={0.3} />
        <pointLight position={[10, 10, 10]} intensity={0.5} color="#22d3ee" />
        <pointLight position={[-10, -10, -10]} intensity={0.3} color="#0ea5e9" />
        <group rotation={[seasonalTilt.x, 0, seasonalTilt.z]}>
          <NeuralNetwork />
          <Globe />
          <GlobeLines />
          <GlobeGlow />
          <ContinentOutlines />
          <CityLights />
          <NetworkLines />
        </group>
        <Particles />
        <OrbitControls
          enableZoom={false}
          enablePan={false}
          autoRotate
          autoRotateSpeed={-0.3}
        />
      </Canvas>
      <div className="absolute inset-0 bg-background/40 pointer-events-none" />
    </div>
  );
}
